services:
  headscale:
    build: ./headplane/headscale
    restart: unless-stopped
    command: serve
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    expose:
      - "8080"
    sysctls:
      net.ipv4.ip_forward: 1
      net.ipv4.conf.all.src_valid_mark: 1
    volumes:
      # Persistent Headscale data
      - headscale-data:/var/lib/headscale
    environment:
      # Expose Headscale via Coolify proxy on its own subdomain (port 8080 in container)
      - SERVICE_URL_HEADSCALE_8080
      # Optional: generate a reusable password / secret specifically for this service
      - SERVICE_SPECIFIC_PASSWORD=${SERVICE_PASSWORD_HEADSCALE}
    healthcheck:
      test:
        - CMD
        - headscale
        - health
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
  headplane:
    build: ./headplane
    restart: unless-stopped
    depends_on:
      - headscale
    expose:
      - "3000"
    volumes:
      # Persistent Headplane data
      - headplane-data:/var/lib/headplane
      # Docker socket (read-only) for integration features
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # Expose Headplane UI via Coolify proxy on port 3000
      - SERVICE_URL_HEADPLANE_3000
      # Example: generate a per-service password / random secret
      - SERVICE_SPECIFIC_PASSWORD=${SERVICE_PASSWORD_HEADPLANE}
    healthcheck:
      test:
        - CMD
        - node
        - '-e'
        - "fetch('http://127.0.0.1:3000').then(r => { if (!r.ok) process.exit(1); }).catch(() => process.exit(1));"
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 45s

volumes:
  headscale-data:
  headplane-data: