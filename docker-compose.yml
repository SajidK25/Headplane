services:
  headscale:
    image: 'headscale/headscale:stable'
    restart: unless-stopped
    command: serve
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      net.ipv4.ip_forward: 1
      net.ipv4.conf.all.src_valid_mark: 1
    volumes:
      - 'headscale-data:/var/lib/headscale'
      - './headscale/config.yaml:/etc/headscale/config.yaml'
    environment:
      - SERVICE_URL_HEADSCALE_8080
      - 'SERVICE_SPECIFIC_PASSWORD=${SERVICE_PASSWORD_HEADSCALE}'
    healthcheck:
      test:
        - CMD
        - headscale
        - health
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s
  headplane:
    image: 'ghcr.io/tale/headplane:latest'
    restart: unless-stopped
    depends_on:
      - headscale
    volumes:
      - 'headplane-data:/var/lib/headplane'
      - '/var/run/docker.sock:/var/run/docker.sock:ro'
      - './headplane/config.yaml:/etc/headplane/config.yaml'
      - './headscale/config.yaml:/etc/headscale/config.yaml'
    environment:
      - SERVICE_URL_HEADPLANE_3000
      - 'SERVICE_SPECIFIC_PASSWORD=${SERVICE_PASSWORD_HEADPLANE}'
    labels:
      - me.tale.headplane.target=headscale
    healthcheck:
      test:
        - CMD
        - node
        - '-e'
        - "fetch('http://127.0.0.1:3000').then(r => { if (!r.ok) process.exit(1); }).catch(() => process.exit(1));"
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 45s

volumes:
  headscale-data:
  headplane-data: